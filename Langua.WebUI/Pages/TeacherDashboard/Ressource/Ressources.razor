@page "/Teacher/Ressources"
@page "/Ressource"
@using System.Reflection.Metadata
@layout TeacherLayout
@inherits BasePage
<RadzenStack>
    <RadzenRow class="my-2">
        <RadzenColumn Size="4">
            <RadzenText Text="@L["Contenus"]" TextStyle="TextStyle.DisplayH4" />
        </RadzenColumn>
        <RadzenColumn Size="6"></RadzenColumn>
        <RadzenColumn Size="2" class="my-2">
            <RadzenButton Click="RddRessource" Icon="add" Text="@L["Add"]" />
        </RadzenColumn>
    </RadzenRow>
    <RadzenRow>
        <RadzenColumn Size="_SizeGridColumn">
            <RadzenDataGrid EmptyText="@L["No Data To Display"]" @ref="ResGrid" Data="Resources" AllowFiltering=true FilterMode="FilterMode.Simple" AllowSorting=true>
                <Columns>
                    <RadzenDataGridColumn Property="Name" Title="@L["Ressource Name"]" />
                    <RadzenDataGridColumn Property="RessourceTypeStr" Title="@L["Ressource Type"]" />
                    <RadzenDataGridColumn Property="GroupsName" Title="@L["Published To"]" />
                    <RadzenDataGridColumn Context="CtxRes" TItem="Langua.Models.Ressource" Width="180px">
                        <Template>
                            <RadzenButton Icon="edit" Size="ButtonSize.Medium" Click="@(args=>Edit(CtxRes))" ButtonStyle="ButtonStyle.Primary" Shade="Shade.Lighter" />
                            <RadzenButton Icon="publish" Size="ButtonSize.Medium" Click="@(arfgs=>Publish(CtxRes))" ButtonStyle="ButtonStyle.Success" Shade="Shade.Lighter" />
                            <RadzenButton Icon="delete" Size="ButtonSize.Medium" Click="@(args=>Delete(CtxRes))" ButtonStyle="ButtonStyle.Danger" Shade="Shade.Lighter" />
                            <RadzenButton Icon="preview" Size="ButtonSize.Medium" Click="@(args=>Preview(CtxRes))" ButtonStyle="ButtonStyle.Info" Shade="Shade.Lighter" />
                        </Template>
                    </RadzenDataGridColumn>
                </Columns>
            </RadzenDataGrid>
        </RadzenColumn>
        <RadzenColumn Size="_SizePreviewColumn" Visible=_PreviewColumnVisible>
            <object type="application/pdf" width="100%" height="400px" data="@base64">
                your browser doesn't support pdf view
            </object>
        </RadzenColumn>
    </RadzenRow>
</RadzenStack>

@code{
    [Inject] public Langua.Repositories.Interfaces.IRepositoryCrudBase<Models.Ressource>? repositoryRessource { get; set; }
    private RadzenDataGrid<Ressource> ResGrid;
    public IEnumerable<Models.Ressource> Resources { get; set; }
    public Ressource ResToEdit { get; set; }
    public string url { get; set; }
    public string base64 { get; set; }
    public async Task RddRessource(){
        var result = await dialogService.OpenAsync<CURessource>(L["Add Contenu"], null);
        await ResGrid.Reload();
    }
    int _SizeGridColumn = 12;
    int _SizePreviewColumn = 0;
    bool _PreviewColumnVisible = false;
    protected override async Task OnInitializedAsync()
    {
        await Security!.InitializedTeacher();
        var resRessources = await LanguaService.GetRessourceByTeacherId(Security.Teacher.Id);
        if (resRessources.Succeeded)
        {
            Resources = resRessources.Value;
            Resources.ToList()?.ForEach(res =>
            {
                res.GroupRessources.ToList()?.ForEach(GR =>
                {
                    res.GroupsName += $"{GR.Group?.Name}, ";
                });
            });
        }
    }
    public async Task Delete(Ressource ressource)
    {
        if (await Confirm(L["Confirm Delete"], L["Are you sure want to delete this item"]) == true)
        {
            var DeleteRes = repositoryRessource.Delete(ressource);
            if (DeleteRes.Succeeded)
            {
                await ResGrid.Reload();
                Notify(L["Successful"], L["The Item successful deleted"], NotificationSeverity.Success);
            }
        }
    }


    private async Task Preview(Ressource r)
    {
        _SizePreviewColumn = 6;
        _SizeGridColumn = 6;
        _PreviewColumnVisible = true;
        url = $"data:application/pdf;base64,{Convert.ToBase64String(r.ContentBytes,0,r.ContentBytes.Length)}";
        base64 = $"data:application/pdf;base64,{r.ContentFile}";
    }

    public async Task Publish(Ressource ressource)
    {
        var result = await dialogService!.OpenAsync<PublishRessource>(L["Publish contenu to groupes"], new Dictionary<string, object> { { "ressource", ressource } });
        if(result == true)
            Notify("Success", "Ressource Created Successfuly!!!!", NotificationSeverity.Success);
        else 
            Notify(L["Error"], L["Creation finished with errors!!!!"], NotificationSeverity.Error);
    }
    public async Task Edit(Ressource ressource)
    {
        ResToEdit = ressource;
        var result = await dialogService!.OpenAsync<CURessource>(L["Edit The Ressource"], new Dictionary<string, object> { { "Id", ressource.Id } });
        if (result == true)
            Notify(L["Success"], L["Ressource updated Successfuly!!!!"], NotificationSeverity.Success);
        else
            Notify(L["Error"], L["Editon finished with errors!!!!"], NotificationSeverity.Error);

    }
}